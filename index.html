<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft 365 Service Health</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0f0f0f;
            --surface: #1a1a1a;
            --surface-hover: #252525;
            --surface-active: #2a2a2a;
            --border: #333;
            --text: #e5e5e5;
            --text-muted: #888;
            --text-dim: #666;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        .app { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .last-updated { font-size: 0.75rem; color: var(--text-muted); }

        .sidebar-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border-bottom: 2px solid transparent;
        }

        .nav-tab:hover { color: var(--text); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .sidebar-filters {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .filter-tabs { display: flex; gap: 0.5rem; }

        .filter-tab {
            flex: 1;
            padding: 0.4rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-tab:hover { background: var(--surface-hover); color: var(--text); }
        .filter-tab.active { background: var(--accent); color: white; }

        .service-list { flex: 1; overflow-y: auto; padding: 0.5rem; }

        .service-group-label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            padding: 0.75rem 1rem 0.25rem;
            margin-top: 0.5rem;
        }

        .service-group-label:first-child { margin-top: 0; }

        .service-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 2px;
        }

        .service-item:hover { background: var(--surface-hover); }
        .service-item.active { background: var(--surface-active); }

        .service-status {
            width: 8px; height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .service-status.operational { background: var(--success); }
        .service-status.degraded { background: var(--warning); }
        .service-status.down { background: var(--danger); }

        .service-info { flex: 1; min-width: 0; }
        .service-name { font-size: 0.85rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .service-issue-count { font-size: 0.7rem; color: var(--text-muted); }

        /* Main */
        .main { flex: 1; margin-left: 280px; padding: 2rem; max-width: 1000px; }
        .main-header { margin-bottom: 2rem; }
        .main-header h2 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-badge.operational { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .status-badge.degraded { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .status-badge.down { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .status-badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

        /* Overview Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .summary-card.status-primary {
            grid-column: 1 / -1;
            border-left: 4px solid var(--accent);
        }

        .summary-card-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .summary-card-value {
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }

        .summary-card.status-ok { border-left: 4px solid var(--success); }
        .summary-card.status-warning { border-left: 4px solid var(--warning); }
        .summary-card.status-danger { border-left: 4px solid var(--danger); }

        .summary-card-impact {
            font-size: 0.85rem;
            color: var(--text);
            line-height: 1.5;
        }

        /* Overview */
        .overview-section { margin-bottom: 2rem; }
        .overview-section h3 {
            font-size: 0.8rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--text-muted); margin-bottom: 1rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .overview-section h3::before { content: ''; width: 8px; height: 8px; border-radius: 50%; }
        .overview-section.incidents h3::before { background: var(--danger); }
        .overview-section.advisories h3::before { background: var(--warning); }

        .overview-issue {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .overview-issue:hover { border-color: #444; }
        .overview-issue-service { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; color: var(--accent); margin-bottom: 0.25rem; }
        .overview-issue-title { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; }
        .overview-issue-impact { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; line-height: 1.5; }
        .overview-issue-meta { font-size: 0.75rem; color: var(--text-muted); }

        /* Issue Cards */
        .issue-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: border-color 0.15s;
        }

        .issue-card:hover { border-color: #444; }
        .issue-card.expanded { border-color: var(--accent); }

        .issue-header {
            padding: 1.25rem;
            cursor: pointer;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .issue-content { flex: 1; min-width: 0; }
        .issue-id { font-size: 0.7rem; font-family: 'SF Mono', Monaco, monospace; color: var(--text-dim); margin-bottom: 0.25rem; }
        .issue-title { font-size: 0.95rem; font-weight: 500; margin-bottom: 0.5rem; line-height: 1.4; }
        .issue-meta { display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.75rem; color: var(--text-muted); }

        .issue-expand {
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-muted);
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .issue-card.expanded .issue-expand { transform: rotate(180deg); }

        .issue-details { display: none; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .issue-card.expanded .issue-details { display: block; }

        .issue-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .issue-info-item label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-dim);
            display: block;
            margin-bottom: 0.25rem;
        }

        .issue-info-item p { font-size: 0.85rem; color: var(--text); }

        /* History detail layout - stacked for long content */
        .history-info-section {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .history-time-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .history-info-block {
            margin-bottom: 1rem;
        }

        .history-info-block:last-child {
            margin-bottom: 0;
        }

        .history-info-block label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-dim);
            display: block;
            margin-bottom: 0.25rem;
        }

        .history-info-block p {
            font-size: 0.85rem;
            color: var(--text);
            line-height: 1.6;
        }

        /* Timeline */
        .timeline { padding: 1.25rem; }
        .timeline-header { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 1rem; }
        .timeline-item { position: relative; padding-left: 1.5rem; padding-bottom: 1.5rem; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item::before { content: ''; position: absolute; left: 0; top: 0.5rem; width: 8px; height: 8px; border-radius: 50%; background: var(--accent); border: 2px solid var(--bg); }
        .timeline-item:not(:last-child)::after { content: ''; position: absolute; left: 3px; top: 1rem; width: 2px; height: calc(100% - 0.5rem); background: var(--border); }
        .timeline-time { font-size: 0.7rem; font-weight: 600; color: var(--accent); margin-bottom: 0.25rem; }
        .timeline-content { font-size: 0.8rem; color: var(--text-muted); line-height: 1.6; }

        /* History */
        .history-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .history-card:hover { border-color: #444; }

        .history-header {
            padding: 1rem 1.25rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .history-service { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--success); margin-bottom: 0.25rem; }
        .history-title { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; }
        .history-dates { font-size: 0.75rem; color: var(--text-muted); }
        .history-duration { font-size: 0.7rem; color: var(--text-dim); text-align: right; white-space: nowrap; }

        .history-details { display: none; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .history-card.expanded .history-details { display: block; }

        .no-issues { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
        .no-issues-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.5; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; border-right: none; border-bottom: 1px solid var(--border); }
            .service-list { display: flex; overflow-x: auto; padding: 0.5rem 1rem; gap: 0.5rem; }
            .service-group-label { display: none; }
            .service-item { flex-shrink: 0; padding: 0.5rem 0.75rem; }
            .service-issue-count { display: none; }
            .main { margin-left: 0; padding: 1rem; }
            .app { flex-direction: column; }
            .history-time-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Service Health</h1>
                <div class="last-updated" id="last-updated">Loading...</div>
            </div>
            <div class="sidebar-nav">
                <button class="nav-tab active" data-view="current">Current Status</button>
                <button class="nav-tab" data-view="history">Issue History</button>
            </div>
            <div class="sidebar-filters" id="sidebar-filters">
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all">All</button>
                    <button class="filter-tab" data-filter="issues">Issues</button>
                    <button class="filter-tab" data-filter="operational">Healthy</button>
                </div>
            </div>
            <div class="service-list" id="service-list"></div>
        </aside>
        <main class="main" id="main-content"></main>
    </div>

    <script>
        let data = null;
        let selectedService = null;
        let currentFilter = 'all';
        let currentView = 'current';

        // Format date to Eastern Time with proper DST handling
        function formatET(dateStr, includeTime = true) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            const options = {
                timeZone: 'America/New_York',
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
            };
            if (includeTime) {
                options.hour = 'numeric';
                options.minute = '2-digit';
                options.second = '2-digit';
                options.hour12 = true;
            }
            return date.toLocaleString('en-US', options) + (includeTime ? ' ET' : '');
        }

        function formatETDateOnly(dateStr) {
            return formatET(dateStr, false);
        }

        // Convert UTC times in text to ET (e.g., "Next update by: January 31, 2026 at 2:00 PM UTC")
        function convertUTCInText(text) {
            if (!text) return text;
            // Match patterns like "Monday, February 2, 2026, at 8:00 AM UTC" or "January 31, 2026, at 2:00 PM UTC"
            const utcPatterns = [
                /(\w+day,? )?(\w+ \d{1,2}, \d{4}),? at (\d{1,2}:\d{2} [AP]M) UTC/gi,
                /(\d{1,2}\/\d{1,2}\/\d{4}),? (\d{1,2}:\d{2}:\d{2} [AP]M) UTC/gi,
                /(\d{1,2}\/\d{1,2}\/\d{4}),? at (\d{1,2}:\d{2} [AP]M) UTC/gi
            ];
            
            let result = text;
            
            // Handle the "Monday, February 2, 2026, at 8:00 AM UTC" format
            result = result.replace(/(\w+day,?\s+)?(\w+ \d{1,2}, \d{4}),?\s+at\s+(\d{1,2}:\d{2}\s*[AP]M)\s*UTC/gi, (match, dayName, dateStr, timeStr) => {
                try {
                    const utcDate = new Date(`${dateStr} ${timeStr} UTC`);
                    if (!isNaN(utcDate.getTime())) {
                        return formatET(utcDate);
                    }
                } catch (e) {}
                return match;
            });
            
            // Handle numeric date formats
            result = result.replace(/(\d{1,2}\/\d{1,2}\/\d{4}),?\s+(\d{1,2}:\d{2}(?::\d{2})?\s*[AP]M)\s*UTC/gi, (match, dateStr, timeStr) => {
                try {
                    const utcDate = new Date(`${dateStr} ${timeStr} UTC`);
                    if (!isNaN(utcDate.getTime())) {
                        return formatET(utcDate);
                    }
                } catch (e) {}
                return match;
            });
            
            return result;
        }

        async function loadData() {
            try {
                // Try relative path first (for GitHub Pages/Static), then fall back to health-data.json (for local dev server)
                let response = await fetch('data.json?t=' + Date.now());
                if (!response.ok) {
                    response = await fetch('health-data.json?t=' + Date.now());
                }
                if (!response.ok) throw new Error('Failed to load');
                data = await response.json();
                document.getElementById('last-updated').textContent = 'Updated ' + formatRelativeTime(data.lastUpdated);
                render();
            } catch (err) {
                document.getElementById('last-updated').textContent = 'Error loading data';
            }
        }

        function formatRelativeTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return formatETDateOnly(dateStr);
        }

        function formatDuration(startStr, endStr) {
            const start = new Date(startStr);
            const end = new Date(endStr);
            const diffMs = end - start;
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays > 0) return `${diffDays}d ${diffHours % 24}h`;
            return `${diffHours}h`;
        }

        function getStatusClass(status) {
            const s = (status || '').toLowerCase();
            if (s === 'serviceoperational') return 'operational';
            if (s.includes('interruption')) return 'down';
            return 'degraded';
        }

        function getServicePriority(service) {
            const hasIncident = service.issues?.some(i => i.status?.toLowerCase().includes('interruption') || i.severity?.toLowerCase() === 'incident');
            const hasIssues = service.issues?.length > 0;
            if (hasIncident) return 0;
            if (hasIssues) return 1;
            return 2;
        }

        function sortServices(services) {
            return [...services].sort((a, b) => {
                const priorityA = getServicePriority(a);
                const priorityB = getServicePriority(b);
                if (priorityA !== priorityB) return priorityA - priorityB;
                return a.service.localeCompare(b.service);
            });
        }

        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html || '';
            return tmp.textContent || tmp.innerText || '';
        }

        function render() {
            document.getElementById('sidebar-filters').style.display = currentView === 'current' ? 'block' : 'none';
            if (currentView === 'current') {
                renderServiceList();
                renderMainContent();
            } else {
                document.getElementById('service-list').innerHTML = '';
                renderHistory();
            }
        }

        function renderServiceList() {
            const list = document.getElementById('service-list');
            let services = sortServices(data.services);
            if (currentFilter === 'issues') services = services.filter(s => s.issues?.length > 0);
            else if (currentFilter === 'operational') services = services.filter(s => !s.issues?.length);

            let html = '';
            let lastGroup = null;

            services.forEach(s => {
                const priority = getServicePriority(s);
                const issueCount = s.issues?.length || 0;
                const isActive = selectedService === s.service;
                
                let groupLabel = null;
                if (priority === 0 && lastGroup !== 0) groupLabel = 'Active Incidents';
                else if (priority === 1 && lastGroup !== 1 && lastGroup !== 0) groupLabel = 'Advisories';
                else if (priority === 2 && lastGroup !== 2) groupLabel = 'Operational';
                
                if (groupLabel && currentFilter === 'all') html += `<div class="service-group-label">${groupLabel}</div>`;
                lastGroup = priority;
                
                const statusClass = priority === 0 ? 'down' : (priority === 1 ? 'degraded' : 'operational');
                
                html += `
                    <div class="service-item ${isActive ? 'active' : ''}" onclick="selectService('${s.service.replace(/'/g, "\\'")}')">
                        <div class="service-status ${statusClass}"></div>
                        <div class="service-info">
                            <div class="service-name">${s.service}</div>
                            ${issueCount > 0 ? `<div class="service-issue-count">${issueCount} issue${issueCount > 1 ? 's' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function selectService(serviceName) {
            selectedService = serviceName;
            renderServiceList();
            renderMainContent();
        }

        function renderMainContent() {
            const main = document.getElementById('main-content');
            if (!selectedService) { renderOverview(main); return; }
            
            const service = data.services.find(s => s.service === selectedService);
            if (!service) { selectedService = null; renderOverview(main); return; }

            const statusClass = getStatusClass(service.status);
            const statusLabel = service.status === 'serviceOperational' ? 'Operational' : service.status.replace(/([A-Z])/g, ' $1').trim();

            main.innerHTML = `
                <div class="main-header">
                    <h2>${service.service}</h2>
                    <span class="status-badge ${statusClass}">${statusLabel}</span>
                </div>
                ${service.issues?.length ? service.issues.map(issue => renderIssue(issue)).join('') : `
                    <div class="no-issues"><div class="no-issues-icon">âœ“</div><p>No active issues</p></div>
                `}
            `;
        }

        function renderOverview(main) {
            const issuesMap = new Map(); // id -> { issue, serviceNames: [] }
            
            data.services.forEach(service => {
                (service.issues || []).forEach(issue => {
                    if (!issuesMap.has(issue.id)) {
                        issuesMap.set(issue.id, {
                            ...issue,
                            serviceNames: issue.affectedServices || [service.service]
                        });
                    }
                });
            });

            const allIssues = Array.from(issuesMap.values());
            
            // Sort by startTime descending (most recent first)
            allIssues.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

            const incidents = allIssues.filter(i => i.status?.toLowerCase().includes('interruption') || i.severity?.toLowerCase() === 'incident');
            const advisories = allIssues.filter(i => !i.status?.toLowerCase().includes('interruption') && i.severity?.toLowerCase() !== 'incident');

            const totalServices = data.services.length;
            const affectedServicesCount = data.services.filter(s => s.issues?.length > 0).length;
            const healthyServicesCount = totalServices - affectedServicesCount;

            let systemStatusLabel = "All Services Operational";
            let systemStatusClass = "status-ok";
            let systemStatusImpact = "No active service issues reported at this time.";

            if (incidents.length > 0) {
                systemStatusLabel = "Service Interruption";
                systemStatusClass = "status-danger";
                const uniqueIncidents = incidents.filter((v, i, a) => a.findIndex(t => t.id === v.id) === i);
                systemStatusImpact = generateConciseSummary(uniqueIncidents, 300);
            } else if (advisories.length > 0) {
                systemStatusLabel = "Degraded Performance";
                systemStatusClass = "status-warning";
                const uniqueAdvisories = advisories.filter((v, i, a) => a.findIndex(t => t.id === v.id) === i);
                systemStatusImpact = generateConciseSummary(uniqueAdvisories, 300);
            }

            function generateConciseSummary(issues, limit) {
                if (!issues.length) return "No active service issues reported.";
                
                // Group by impact to avoid repetition
                const items = issues.map(i => {
                    const services = i.serviceNames.join(', ')
                        .replace(/Microsoft /g, '')
                        .replace(/Online/g, '')
                        .replace(/ for Business/g, '');
                    
                    let text = stripHtml(i.userImpact).split(/[.!?]/)[0].trim();
                    // Strip generic prefixes
                    text = text.replace(/Users (?:may|might|could|are) (?:experience|be experiencing|encounter|seeing)/gi, "")
                        .replace(/There is an issue /gi, "")
                        .trim();
                    
                    return { services, text };
                });
                
                // Deduplicate impacts
                const unique = [];
                const seen = new Set();
                for (const item of items) {
                    if (!seen.has(item.text.toLowerCase())) {
                        unique.push(item);
                        seen.add(item.text.toLowerCase());
                    }
                }

                let summary = unique.map(u => `<b>${u.services}:</b> ${u.text}`).join(". ");
                
                if (summary.length > limit) {
                    summary = summary.substring(0, limit - 3).trim() + "...";
                }
                return summary + (summary.endsWith(".") || summary.endsWith("...") ? "" : ".");
            }

            let html = `
                <div class="main-header">
                    <h2>Suite Overview</h2>
                    <p style="color:var(--text-muted);font-size:0.9rem">Current health across all Microsoft 365 services</p>
                </div>

                <div class="summary-grid">
                    <div class="summary-card status-primary ${systemStatusClass}">
                        <div class="summary-card-label">Overall Status</div>
                        <div class="summary-card-value">${systemStatusLabel}</div>
                        <div class="summary-card-impact">${systemStatusImpact}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-label">Services</div>
                        <div class="summary-card-value">${healthyServicesCount} / ${totalServices}</div>
                        <div class="summary-card-impact">Healthy services currently operational.</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-label">Active Issues</div>
                        <div class="summary-card-value">${allIssues.length}</div>
                        <div class="summary-card-impact">${incidents.length} incidents, ${advisories.length} advisories.</div>
                    </div>
                </div>
            `;

            if (allIssues.length === 0) {
                html += `<div class="no-issues"><div class="no-issues-icon">âœ“</div><p>No active issues</p></div>`;
                main.innerHTML = html;
                return;
            }

            if (incidents.length > 0) {
                html += `<div class="overview-section incidents"><h3>Incidents (${incidents.length})</h3>${incidents.map(i => renderOverviewIssue(i)).join('')}</div>`;
            }

            if (advisories.length > 0) {
                html += `<div class="overview-section advisories"><h3>Advisories (${advisories.length})</h3>${advisories.map(i => renderOverviewIssue(i)).join('')}</div>`;
            }

            main.innerHTML = html;
        }

        function renderOverviewIssue(i) {
            const userImpactText = i.userImpact ? stripHtml(i.userImpact) : '';
            const truncatedImpact = userImpactText.length > 200 ? userImpactText.substring(0, 200) + '...' : userImpactText;
            const servicesText = i.serviceNames.join(', ');
            
            return `
                <div class="overview-issue" onclick="selectIssue('${i.serviceNames[0].replace(/'/g, "\\'")}', '${i.id}')">
                    <div class="overview-issue-service">${servicesText}</div>
                    <div class="overview-issue-title">${i.title}</div>
                    ${truncatedImpact ? `<div class="overview-issue-impact">${truncatedImpact}</div>` : ''}
                    <div class="overview-issue-meta">
                        Started ${formatETDateOnly(i.startTime)} Â· Updated ${formatRelativeTime(i.lastModified)}
                        ${i.nextUpdateBy ? ` Â· <span style="color:var(--warning)">Next update: ${convertUTCInText(i.nextUpdateBy)}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function selectIssue(serviceName, issueId) {
            selectedService = serviceName;
            renderServiceList();
            renderMainContent();
            // Scroll to and expand the specific issue
            setTimeout(() => {
                const issueEl = document.getElementById('issue-' + issueId);
                if (issueEl) {
                    issueEl.classList.add('expanded');
                    issueEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }

        function renderIssue(issue) {
            const posts = issue.posts || [];
            const servicesText = issue.affectedServices ? issue.affectedServices.join(', ') : '';
            
            return `
                <div class="issue-card" id="issue-${issue.id}">
                    <div class="issue-header" onclick="toggleIssue('${issue.id}')">
                        <div class="issue-content">
                            <div class="issue-id">${issue.id}</div>
                            <div class="issue-title">${issue.title}</div>
                            <div class="issue-meta">
                                <span>Started ${formatETDateOnly(issue.startTime)}</span>
                                ${issue.lastModified ? `<span>Updated ${formatRelativeTime(issue.lastModified)}</span>` : ''}
                                ${issue.nextUpdateBy ? `<span style="color:var(--warning)">Next update: ${convertUTCInText(issue.nextUpdateBy)}</span>` : ''}
                                <span>${posts.length} updates</span>
                            </div>
                        </div>
                        <div class="issue-expand"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
                    </div>
                    <div class="issue-details">
                        <div class="issue-info-grid">
                            ${servicesText ? `<div class="issue-info-item"><label>Affected Services</label><p style="color:var(--accent);font-weight:500">${servicesText}</p></div>` : ''}
                            ${issue.nextUpdateBy ? `<div class="issue-info-item"><label>Next Update By</label><p style="color:var(--warning)">${convertUTCInText(issue.nextUpdateBy)}</p></div>` : ''}
                            ${issue.userImpact ? `<div class="issue-info-item"><label>User Impact</label><p>${stripHtml(issue.userImpact)}</p></div>` : ''}
                            ${issue.scopeOfImpact ? `<div class="issue-info-item"><label>Scope of Impact</label><p>${convertUTCInText(stripHtml(issue.scopeOfImpact))}</p></div>` : ''}
                            ${issue.rootCause ? `<div class="issue-info-item"><label>Root Cause</label><p>${stripHtml(issue.rootCause)}</p></div>` : ''}
                        </div>
                        <div class="timeline">
                            <div class="timeline-header">Update Timeline (${posts.length})</div>
                            ${posts.map(post => `
                                <div class="timeline-item">
                                    <div class="timeline-time">${formatET(post.createdAt)}</div>
                                    <div class="timeline-content">${convertUTCInText(formatPost(post.content))}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            const main = document.getElementById('main-content');
            const history = data.history || [];

            if (history.length === 0) {
                main.innerHTML = `<div class="main-header"><h2>Issue History</h2><p style="color:var(--text-muted)">Past 30 days</p></div><div class="no-issues"><div class="no-issues-icon">ðŸ“‹</div><p>No resolved issues in the past 30 days</p></div>`;
                return;
            }

            main.innerHTML = `
                <div class="main-header">
                    <h2>Issue History</h2>
                    <p style="color:var(--text-muted);font-size:0.9rem">${history.length} resolved issues in the past 30 days</p>
                </div>
                ${history.map(issue => `
                    <div class="history-card" id="history-${issue.id}">
                        <div class="history-header" onclick="toggleHistory('${issue.id}')">
                            <div>
                                <div class="history-service">${issue.serviceName} Â· Resolved</div>
                                <div class="history-title">${issue.title}</div>
                                <div class="history-dates">${formatETDateOnly(issue.startTime)} â†’ ${formatETDateOnly(issue.endTime || issue.lastModified)}</div>
                            </div>
                            <div class="history-duration">${formatDuration(issue.startTime, issue.endTime || issue.lastModified)}</div>
                        </div>
                        <div class="history-details">
                            <div class="history-info-section">
                                <div class="history-time-row">
                                    <div class="history-info-block">
                                        <label>Start Time</label>
                                        <p>${formatET(issue.startTime)}</p>
                                    </div>
                                    <div class="history-info-block">
                                        <label>End Time</label>
                                        <p>${formatET(issue.endTime || issue.lastModified)}</p>
                                    </div>
                                </div>
                                ${issue.userImpact ? `
                                    <div class="history-info-block">
                                        <label>User Impact</label>
                                        <p>${stripHtml(issue.userImpact)}</p>
                                    </div>
                                ` : ''}
                                ${issue.scopeOfImpact ? `
                                    <div class="history-info-block">
                                        <label>Scope of Impact</label>
                                        <p>${convertUTCInText(stripHtml(issue.scopeOfImpact))}</p>
                                    </div>
                                ` : ''}
                                ${issue.rootCause ? `
                                    <div class="history-info-block">
                                        <label>Root Cause</label>
                                        <p>${stripHtml(issue.rootCause)}</p>
                                    </div>
                                ` : ''}
                            </div>
                            ${issue.posts?.length ? `
                                <div class="timeline">
                                    <div class="timeline-header">Recent Updates</div>
                                    ${issue.posts.slice(0, 3).map(post => `
                                        <div class="timeline-item">
                                            <div class="timeline-time">${formatET(post.createdAt)}</div>
                                            <div class="timeline-content">${convertUTCInText(formatPost(post.content))}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function formatPost(content) {
            const text = stripHtml(content);
            const statusMatch = text.match(/Current status:\s*([^]*?)(?=Scope of impact:|Root cause:|Next update by:|Final status:|$)/i);
            if (statusMatch) return statusMatch[1].trim().substring(0, 500) + (statusMatch[1].length > 500 ? '...' : '');
            const finalMatch = text.match(/Final status:\s*([^]*?)(?=Scope of impact:|Root cause:|$)/i);
            if (finalMatch) return finalMatch[1].trim().substring(0, 500) + (finalMatch[1].length > 500 ? '...' : '');
            return text.substring(0, 400) + (text.length > 400 ? '...' : '');
        }

        function toggleIssue(issueId) { document.getElementById('issue-' + issueId).classList.toggle('expanded'); }
        function toggleHistory(issueId) { document.getElementById('history-' + issueId).classList.toggle('expanded'); }

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentView = tab.dataset.view;
                selectedService = null;
                render();
            });
        });

        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                selectedService = null;
                render();
            });
        });

        loadData();
    </script>
</body>
</html>
